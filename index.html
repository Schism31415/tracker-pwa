// =============================
// Premium Investor App (v4)
// =============================

// Data store
let tenants = [];
let currentTenant = null;
let entries = [];
let sessions = {};

// Chart references
let incomeExpenseChart;
let cashFlowChart;

// =============================
// Tenant Management
// =============================
const tenantSelect = document.getElementById("tenantSelect");
const addTenantBtn = document.getElementById("addTenantBtn");
const removeTenantBtn = document.getElementById("removeTenantBtn");
const tenantNameInput = document.getElementById("tenantName");

addTenantBtn.addEventListener("click", () => {
  const name = tenantNameInput.value.trim();
  if (name && !tenants.includes(name)) {
    tenants.push(name);
    const option = document.createElement("option");
    option.value = name;
    option.textContent = name;
    tenantSelect.appendChild(option);
    tenantSelect.value = name;
    currentTenant = name;
    entries = [];
    updateCharts();
  }
  tenantNameInput.value = "";
});

removeTenantBtn.addEventListener("click", () => {
  const selected = tenantSelect.value;
  if (!selected) return;
  tenants = tenants.filter(t => t !== selected);
  [...tenantSelect.options].forEach(opt => {
    if (opt.value === selected) opt.remove();
  });
  if (tenants.length > 0) {
    currentTenant = tenants[0];
    tenantSelect.value = currentTenant;
  } else {
    currentTenant = null;
    entries = [];
  }
  updateCharts();
});

tenantSelect.addEventListener("change", () => {
  currentTenant = tenantSelect.value;
  entries = [];
  updateCharts();
});

// =============================
// Entries
// =============================
const entryForm = document.getElementById("entryForm");
entryForm.addEventListener("submit", (e) => {
  e.preventDefault();
  if (!currentTenant) {
    alert("Please add and select a tenant first.");
    return;
  }

  const type = document.getElementById("type").value;
  const amount = parseFloat(document.getElementById("amount").value);
  const source = document.getElementById("source").value.trim();

  if (!isNaN(amount) && amount > 0) {
    entries.push({ type, amount, source, tenant: currentTenant, date: new Date() });
    updateCharts();
    entryForm.reset();
  }
});

// =============================
// Chart Updates
// =============================
function updateCharts() {
  const ctx1 = document.getElementById("incomeExpenseChart").getContext("2d");
  const ctx2 = document.getElementById("cashFlowChart").getContext("2d");

  if (incomeExpenseChart) incomeExpenseChart.destroy();
  if (cashFlowChart) cashFlowChart.destroy();

  let income = 0, expenses = 0;
  entries.forEach(e => {
    if (e.type === "income") income += e.amount;
    if (e.type === "expense") expenses += e.amount;
  });

  // Income vs Expenses
  incomeExpenseChart = new Chart(ctx1, {
    type: "bar",
    data: {
      labels: ["Income", "Expenses"],
      datasets: [{
        label: "Amount",
        data: [income, expenses],
        backgroundColor: ["#4caf50", "#f44336"]
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } }
    }
  });

  // Cash Flow chart
  let balance = 0;
  const balances = entries.map(e => {
    balance += (e.type === "income" ? e.amount : -e.amount);
    return balance;
  });

  cashFlowChart = new Chart(ctx2, {
    type: "line",
    data: {
      labels: entries.map((e, i) => `#${i + 1}`),
      datasets: [{
        label: "Cash Flow",
        data: balances,
        borderColor: "#ffd700",
        backgroundColor: "rgba(255,215,0,0.2)",
        fill: true,
        tension: 0.2
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } }
    }
  });
}

// =============================
// Sessions
// =============================
const saveSessionBtn = document.getElementById("saveSessionBtn");
const loadSessionBtn = document.getElementById("loadSessionBtn");
const deleteSessionBtn = document.getElementById("deleteSessionBtn");
const sessionSelect = document.getElementById("sessionSelect");
const sessionNameInput = document.getElementById("sessionName");

saveSessionBtn.addEventListener("click", () => {
  const name = sessionNameInput.value.trim();
  if (!name) return;
  sessions[name] = { tenants, currentTenant, entries };
  if (![...sessionSelect.options].some(opt => opt.value === name)) {
    const option = document.createElement("option");
    option.value = name;
    option.textContent = name;
    sessionSelect.appendChild(option);
  }
  sessionSelect.value = name;
  sessionNameInput.value = "";
});

loadSessionBtn.addEventListener("click", () => {
  const selected = sessionSelect.value;
  if (!selected || !sessions[selected]) return;
  ({ tenants, currentTenant, entries } = JSON.parse(JSON.stringify(sessions[selected])));

  tenantSelect.innerHTML = "";
  tenants.forEach(t => {
    const option = document.createElement("option");
    option.value = t;
    option.textContent = t;
    tenantSelect.appendChild(option);
  });
  tenantSelect.value = currentTenant;
  updateCharts();
});

deleteSessionBtn.addEventListener("click", () => {
  const selected = sessionSelect.value;
  if (!selected) return;
  delete sessions[selected];
  [...sessionSelect.options].forEach(opt => {
    if (opt.value === selected) opt.remove();
  });
});

// =============================
// Init
// =============================
updateCharts();
